# Lightbridge Authorization Umbrella Chart (lightbridge-authz-umbrella)

## Purpose
The `lightbridge-authz-umbrella` Helm chart serves as the main entry point for deploying the entire Lightbridge authorization system. It is an umbrella chart, meaning it does not contain any Kubernetes templates of its own. Instead, it manages the deployment and configuration of its sub-charts: `lightbridge-authz` and `lightbridge-config`. This chart provides a single, centralized point of control for the entire application stack, allowing for global configurations and the ability to enable or disable individual sub-charts as needed.

## Architecture
As an umbrella chart, `lightbridge-authz-umbrella`'s architecture is defined by its role in orchestrating its dependencies. It uses Helm's dependency management to deploy and configure `lightbridge-authz` and `lightbridge-config`. Its `values.yaml` file is designed to pass configurations down to these sub-charts, allowing for a unified deployment experience.

## Configuration
The `values.yaml` for `lightbridge-authz-umbrella` focuses on global settings and overrides for its sub-charts:

*   **`global`**:
    *   `namespace`: Specifies the Kubernetes namespace where all components will be deployed (e.g., `lightbridge`).
    *   `imagePullPolicy`: Sets the default image pull policy for containers within the sub-charts.

*   **`lightbridge-authz`**: This section allows overriding values specific to the `lightbridge-authz` chart:
    *   `enabled`: A boolean to enable or disable the deployment of the `lightbridge-authz` service.
    *   `app-template.enabled`: Enables the `app-template` dependency within `lightbridge-authz`.
    *   `controllers.main.containers.main.image.repository` and `tag`: Specifies the Docker image and tag for the `lightbridge-authz` service.
    *   `service.main.ports.http.port`: Overrides the HTTP port for the `lightbridge-authz` service.

*   **`lightbridge-config`**: This section allows overriding values specific to the `lightbridge-config` chart:
    *   `enabled`: A boolean to enable or disable the deployment of the `lightbridge-config` resources.
    *   `tlsPolicies.google.enabled` and `validation.certSecret`: Configures TLS for Google AI provider connections, expecting a Kubernetes secret for certificates (e.g., `google-tls-cert`).
    *   `tlsPolicies.openai.enabled` and `validation.certSecret`: Configures TLS for OpenAI AI provider connections, expecting a Kubernetes secret for certificates (e.g., `openai-tls-cert`).
 
    *   `clientTraffic`: Overrides client traffic policies, including `targetRef` (pointing to a Gateway, e.g., `eg`), `enableProxyProtocol`, and `tcpKeepalive` settings.

## Dependencies
The `lightbridge-authz-umbrella` chart has the following direct Helm chart dependencies:
*   `lightbridge-authz`: Deploys the core authorization service.
*   `lightbridge-config`: Deploys the configuration and policy management for the authorization system. This dependency can be conditionally enabled/disabled via `lightbridge-config.enabled`.

Both sub-charts are expected to be found in the `https://adorsys-gis.github.io/ai-helm/` Helm repository.

## Interaction with other Lightbridge Charts
This chart acts as the orchestrator for the `lightbridge-authz` and `lightbridge-config` charts.
*   It deploys both `lightbridge-authz` (the authorization service) and `lightbridge-config` (the policy and AI provider configuration).
*   It provides a centralized `values.yaml` to configure both sub-charts, allowing for consistent deployment and management of the entire Lightbridge authorization system.

## External Dependencies
The `lightbridge-authz-umbrella` chart itself does not introduce new external dependencies. Its external dependencies are inherited from its sub-charts:
*   **PostgreSQL Database**: Required by `lightbridge-authz`.
*   **OAuth2/OIDC Provider (e.g., Keycloak)**: Required by `lightbridge-authz` for token validation.
*   **Kubernetes Gateway API Gateway**: Required by `lightbridge-config` for applying traffic and security policies.
*   **AI Service Providers (e.g., OpenAI, Google Vertex AI)**: Configured and managed by `lightbridge-config`.
*   **Kubernetes Secrets**: For authentication to AI providers and potentially for TLS certificates, as configured in `lightbridge-config`.
*   **Service Mesh / API Gateway**: The underlying infrastructure that consumes the custom resources generated by `lightbridge-config` to enforce policies.

## Testing Requirements
Testing the `lightbridge-authz-umbrella` chart involves deploying it and verifying that both `lightbridge-authz` and `lightbridge-config` are deployed correctly and function as expected. This includes:
*   **Sub-chart Deployment**: Confirming that pods for `lightbridge-authz` are running and that `lightbridge-config`'s custom resources are created.
*   **Inter-service Communication**: Ensuring `lightbridge-authz` can connect to its database and OAuth provider, and that `lightbridge-config` can properly configure the service mesh to use `lightbridge-authz` for external authorization and connect to AI providers.
*   **Policy Enforcement**: Verifying that rate limits, access tiers, and routing rules defined in `lightbridge-config` are correctly applied by the service mesh.

A comprehensive test setup would require a Kubernetes cluster with the Gateway API, a PostgreSQL database, an OAuth2/OIDC provider (like Keycloak), and configured AI provider secrets.