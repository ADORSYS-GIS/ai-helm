app-template:
  controllers:
    main:
      initContainers:
        config-generator:
          image:
            repository: busybox
            tag: latest
          command:
            - /bin/sh
            - -c
            - |
              # Read the sensitive values from the secret
              DATABASE_URL=$(cat /secrets/DATABASE_URL)
              JWKS_URL=$(cat /secrets/JWKS_URL)
  
              # Read the config template from the configmap
              CONFIG_TEMPLATE=$(cat /config-template/config.yaml)
  
              # Replace the placeholders in the template
              CONFIG_CONTENT=$(echo "$CONFIG_TEMPLATE" | sed "s|{{DATABASE_URL}}|$DATABASE_URL|" | sed "s|{{JWKS_URL}}|$JWKS_URL|")
  
              # Write the final config file
              echo "$CONFIG_CONTENT" > /config/config.yaml
      containers:
        main:
          image:
            repository: ghcr.io/franck-sorel/lightbridge-authz
            tag: latest
          env:
            CONFIG_PATH: /config/config.yaml
          probes:
            liveness:
              enabled: true
              spec:
                httpGet:
                  path: /
                  port: 3000
            readiness:
              enabled: true
              spec:
                httpGet:
                  path: /
                  port: 3000

  service:
    main:
      ports:
        http:
          port: 3000

  persistence:
    secrets:
      enabled: true
      type: secret
      name: lightbridge-authz-secrets
      globalMounts:
        - path: /secrets
          readOnly: true
    config-template:
      enabled: true
      type: configMap
      identifier: config-template
      globalMounts:
        - path: /config-template
          readOnly: true
    config:
      enabled: true
      type: emptyDir
      globalMounts:
        - path: /config

  configMaps:
    config-template:
      enabled: true
      data:
        config.yaml: |
          server:
            rest:
              address: "0.0.0.0"
              port: 3000
            grpc:
              address: "0.0.0.0"
              port: 3001
          logging:
            level: "info"
          database:
            url: "{{`{{DATABASE_URL}}`}}"
            pool_size: 10
          oauth2:
            jwks_url: "{{`{{JWKS_URL}}`}}"
