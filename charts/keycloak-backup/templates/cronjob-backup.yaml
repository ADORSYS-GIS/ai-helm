{{- if .Values.controllers.cronjob.enabled }}
{{- include "keycloak-backup.validateValues" . -}}
{{- $cronjob := .Values.controllers.cronjob -}}
{{- $root := . -}}

apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "keycloak-backup.cronjobName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak-backup.labels" . | nindent 4 }}
    {{- if $cronjob.labels }}
    {{- toYaml $cronjob.labels | nindent 4 }}
    {{- end }}
  annotations:
    {{- if $cronjob.annotations }}
    {{- toYaml $cronjob.annotations | nindent 4 }}
    {{- end }}
    description: "Scheduled Keycloak full configuration backup using kc.sh export"
spec:
  schedule: {{ $cronjob.schedule | quote }}
  successfulJobsHistoryLimit: {{ $cronjob.successfulJobsHistoryLimit | default 3 }}
  failedJobsHistoryLimit: {{ $cronjob.failedJobsHistoryLimit | default 3 }}
  concurrencyPolicy: {{ $cronjob.concurrencyPolicy | default "Forbid" }}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: quay.io/keycloak/keycloak:24.0
              env:
                - name: KEYCLOAK_ADMIN
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.keycloak.secretName }}
                      key: username
                - name: KEYCLOAK_ADMIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.keycloak.secretName }}
                      key: password
                - name: KC_HOSTNAME
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.keycloak.secretName }}
                      key: hostname
                - name: S3_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_BUCKET_NAME
                - name: S3_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_ACCESS_KEY_ID
                - name: S3_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_SECRET_ACCESS_KEY
                - name: S3_REGION
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_REGION_NAME
              command:
                - /bin/sh
                - -c
                - |
                  TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
                  
                  # Start Keycloak in temporary mode for export
                  echo "Starting Keycloak for full export..."
                  
                  {{- if .Values.keycloak.realm }}
                  # Export specific realm including everything using kc.sh
                  echo "Exporting realm: {{ .Values.keycloak.realm }} (including users)"
                  /opt/keycloak/bin/kc.sh export \
                    --realm {{ .Values.keycloak.realm }} \
                    --file /tmp/{{ .Values.keycloak.realm }}_${TIMESTAMP}.json \
                    --users include
                  
                  # Compress and upload
                  gzip -c /tmp/{{ .Values.keycloak.realm }}_${TIMESTAMP}.json > /tmp/{{ .Values.keycloak.realm }}_${TIMESTAMP}.json.gz
                  
                  if [ -n "{{ $root.Values.s3.prefix }}" ]; then
                    aws s3 cp /tmp/{{ .Values.keycloak.realm }}_${TIMESTAMP}.json.gz s3://{{ $root.Values.s3.secretName }}/{{ $root.Values.s3.prefix }}/
                  else
                    aws s3 cp /tmp/{{ .Values.keycloak.realm }}_${TIMESTAMP}.json.gz s3://${S3_BUCKET}/
                  fi
                  
                  rm -f /tmp/{{ .Values.keycloak.realm }}_${TIMESTAMP}.json.gz
                  
                  {{- else }}
                  # Export all realms including everything using kc.sh
                  echo "Exporting all realms (including users)..."
                  /opt/keycloak/bin/kc.sh export \
                    --file /tmp/all-realms_${TIMESTAMP}.json \
                    --users include
                  
                  # Compress and upload
                  gzip -c /tmp/all-realms_${TIMESTAMP}.json > /tmp/all-realms_${TIMESTAMP}.json.gz
                  
                  if [ -n "{{ $root.Values.s3.prefix }}" ]; then
                    aws s3 cp /tmp/all-realms_${TIMESTAMP}.json.gz s3://{{ $root.Values.s3.secretName }}/{{ $root.Values.s3.prefix }}/
                  else
                    aws s3 cp /tmp/all-realms_${TIMESTAMP}.json.gz s3://${S3_BUCKET}/
                  fi
                  
                  rm -f /tmp/all-realms_${TIMESTAMP}.json.gz
                  {{- end }}
                  
                  echo "Full backup completed successfully!"
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          restartPolicy: OnFailure
{{- end }}
