{{- if .Values.controllers.cronjob.enabled }}
{{- include "keycloak-backup.validateValues" . -}}
{{- $cronjob := .Values.controllers.cronjob -}}
{{- $root := . -}}

apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "keycloak-backup.cronjobName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak-backup.labels" . | nindent 4 }}
    {{- if $cronjob.labels }}
    {{- toYaml $cronjob.labels | nindent 4 }}
    {{- end }}
  annotations:
    {{- if $cronjob.annotations }}
    {{- toYaml $cronjob.annotations | nindent 4 }}
    {{- end }}
    description: "Keycloak configuration backup using kc.sh export"
spec:
  schedule: {{ $cronjob.schedule | quote }}
  successfulJobsHistoryLimit: {{ $cronjob.successfulJobsHistoryLimit | default 3 }}
  failedJobsHistoryLimit: {{ $cronjob.failedJobsHistoryLimit | default 3 }}
  concurrencyPolicy: {{ $cronjob.concurrencyPolicy | default "Forbid" }}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: uploader
              image: amazon/aws-cli:2.15.0
              env:
                - name: S3_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_BUCKET_NAME
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_ACCESS_KEY_ID
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_SECRET_ACCESS_KEY
                # - name: AWS_SESSION_TOKEN
                #   valueFrom:
                #     secretKeyRef:
                #       name: {{ $root.Values.s3.secretName }}
                #       key: AWS_SESSION_TOKEN
                - name: AWS_DEFAULT_REGION
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.s3.secretName }}
                      key: S3_REGION_NAME
              command:
                - /bin/sh
                - -c
                - |
                  TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
                  
                  # Wait for export
                  echo "Waiting for export..."
                  while [ ! -f /exported/realm_backup.json ]; do
                    sleep 2
                  done
                  
                  {{- if .Values.keycloak.realm }}
                  BACKUP_FILE="{{ .Values.keycloak.realm }}_${TIMESTAMP}.json"
                  {{- else }}
                  BACKUP_FILE="all-realms_${TIMESTAMP}.json"
                  {{- end }}
                  
                  # Upload to S3
                  aws s3 cp /exported/realm_backup.json s3://${S3_BUCKET}/{{ $root.Values.s3.prefix }}/${BACKUP_FILE}
                  
                  echo "Uploaded: $BACKUP_FILE"
              volumeMounts:
                - name: export-volume
                  mountPath: /exported
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          initContainers:
            - name: exporter
              image: quay.io/keycloak/keycloak:24.0
              env:
                - name: KEYCLOAK_ADMIN
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.keycloak.secretName }}
                      key: username
                - name: KEYCLOAK_ADMIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.keycloak.secretName }}
                      key: password
                - name: KC_HOSTNAME
                  valueFrom:
                    secretKeyRef:
                      name: {{ $root.Values.keycloak.secretName }}
                      key: hostname
              command:
                - /bin/sh
                - -c
                - |
                  TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
                  
                  # Create writable directory for Quarkus build
                  export QUARKUS_CACHE_DIR=/tmp/quarkus-cache
                  mkdir -p $QUARKUS_CACHE_DIR
                  
                  {{- if .Values.keycloak.realm }}
                  echo "Exporting realm: {{ .Values.keycloak.realm }}"
                  KC_CACHE_DIR=$QUARKUS_CACHE_DIR /opt/keycloak/bin/kc.sh export \
                    --realm {{ .Values.keycloak.realm }} \
                    --file /exported/realm_backup.json \
                    --users realm_file --optimized
                  {{- else }}
                  echo "Exporting all realms"
                  KC_CACHE_DIR=$QUARKUS_CACHE_DIR /opt/keycloak/bin/kc.sh export \
                    --all \
                    --file /exported/realm_backup.json \
                    --users realm_file --optimized
                  {{- end }}
                  
                  echo "Export complete"
              volumeMounts:
                - name: export-volume
                  mountPath: /exported
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
                runAsNonRoot: true
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: export-volume
              emptyDir: {}
          restartPolicy: OnFailure
{{- end }}
